---
layout: post
title: "ABTest常见误区——多重检验问题"
date: 2021-07-05
description: "ABTest多重检验问题"
tag: 数据分析
katex: true
---

多重检验问题（Multiple Testing Problem）指的是当同时比较多个检验时，第一类错误率a就会增大，而结果的准确性就会受到影响。

一般来说，显著性水平为5%，看上去是一个比较小的概率，但是如果检验的次数比较多的话，情况就不一样了。如果每个检验出现第一类错误的概率是 5%，那么在这 20 个检验中至少出现一个第一类错误的概率是多少呢？
$$
P（至少出现一个第一类错误）=1 - 95 \% ^ {20} = 64 \%
$$
这里的 P（至少出现一个第一类错误）的概率又叫做 FWER （Family-wise Error Rate）。通过计算得出来的概率是 64%。这就意味着当同时比较 20 个检验时，在这 20 个结果中，至少出现一个第一类错误的概率是 64%。

我们可以得到两条比较有用的结论：

1. 随着检验次数的增加，FWER会变大；
2. 当a越小，FWER会越小，上升的速度随着检验次数上升而减缓

## 出现多重检验问题的形式

1. 一个测试里面不止一个实验组，A/B/n；
2. 不止一个观察指标；
3. 当需要做细分分析时；
4. 测试过程中，不断去查看实验结果

## 解决多重检验的方法

首先针对第4种形式，不断去查看实验结果来说，一定要等到实验样本量到达最低样本量后再去分析结果。

针对前三种形式来说，可以采取两个思路：

1. 保持每个检验的 P-value 不变，调整 a 。
2. 保持 a 不变，调整每个检验的 p-value 。

### 邦佛朗尼校正(Bonferroni Correction)

这个是属于第一种思路，调整 a 。这个方法比较简单，就是把 a 变为 a/n。

其中 n 是检验的个数。比如α=5%，那当我们比较 20 个检验时，校正之后的α=5%/20 = 0.25%，此时的 $FWER =1−(1−0.25\%)^{20} = 4.88\%$ ，和我们最初设定的α=5% 差不多。

这个校正方法适合检验次数少的时候，由于它对于不同的 p-value 采取一刀切的办法，所以太过于保守。

### BH法（Benjamini-Hochberg Procedure）

这个属于第二种思路，调整 p-value。BH 法会考虑到每个 P 值的大小，然后做不同程度的调整。大致的调整方法就是把各个检验计算出的 P 值从小到大排序，然后根据排序来分别调整不同的 P 值，最后再用调整后的 P 值和α进行比较。通常来说，使用 Python中的 multipletests 函数来做。

这个检验方法比较适合检测次数较大的时候。



